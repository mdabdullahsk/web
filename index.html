<!-- START OF FILE studio_pro_v3.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudioPro Elite - Final V3 (Group & Lock)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #3b82f6; 
            --bg-dark: #1e1e1e; 
            --panel-bg: #262626;
            --border: #3f3f46;
            --guide-color: #ff00ff;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg-dark); 
            color: #e2e8f0; 
            margin: 0; height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- Toolbar --- */
        #toolkit-sidebar { 
            width: 50px; position: fixed; left: 0; top: 50px; bottom: 0; 
            z-index: 2000; background: var(--panel-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding-top: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }

        .tool-item {
            width: 36px; height: 36px; margin-bottom: 10px; border-radius: 6px;
            display: flex; justify-content: center; align-items: center;
            cursor: grab; transition: 0.2s; color: #a1a1aa; position: relative;
        }
        .tool-item:hover { background: #3f3f46; color: white; }
        .tool-item:active { cursor: grabbing; }
        
        .tool-item::after {
            content: attr(data-label); position: absolute; left: 45px; 
            background: black; color: white; padding: 4px 8px; font-size: 10px; 
            border-radius: 4px; opacity: 0; pointer-events: none; transition: 0.2s; 
            white-space: nowrap; z-index: 3000;
        }
        .tool-item:hover::after { opacity: 1; }

        /* --- Properties Panel --- */
        #properties {
            width: 280px; background: var(--panel-bg); border-left: 1px solid var(--border);
            position: fixed; right: -280px; top: 50px; bottom: 0; z-index: 2000; 
            display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #properties.open { right: 0; }
        
        .prop-section { padding: 15px; border-bottom: 1px solid var(--border); }
        .prop-title { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        .prop-input, .prop-select {
            width: 100%; background: #18181b; border: 1px solid #3f3f46;
            color: white; padding: 6px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 6px;
        }
        .prop-input:focus { border-color: var(--accent); outline: none; }
        .prop-row { display: flex; gap: 8px; }

        /* --- Workspace --- */
        #workspace {
            position: absolute; top: 50px; bottom: 0; left: 50px; right: 0;
            overflow: hidden; background-color: #121212; 
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
        }
        #workspace.panning, body.is-panning { cursor: grab !important; }
        body.is-panning:active { cursor: grabbing !important; }

        #zoom-wrapper {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            transform-origin: center center;
        }

        #canvas {
            background: #ffffff; position: relative; 
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* --- Smart Guides --- */
        #guide-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 99999; overflow: hidden;
        }
        .guide-line { position: absolute; background-color: var(--guide-color); pointer-events: none; }
        .guide-v { width: 1px; height: 100%; top: 0; border-left: 1px dashed var(--guide-color); background: transparent; }
        .guide-h { height: 1px; width: 100%; left: 0; border-top: 1px dashed var(--guide-color); background: transparent; }

        /* --- Elements --- */
        .builder-element { position: absolute; cursor: move; box-sizing: border-box; border: 1px solid transparent; }
        
        /* FIX: No Z-Index change on selected, just border */
        .builder-element.selected { border: 1px solid var(--accent); }
        .builder-element.locked.selected { border: 1px solid #ef4444; cursor: not-allowed; }

        /* Floating Element Controls - Always on top */
        .element-controls {
            position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
            background: #18181b; padding: 4px; border-radius: 8px; display: none; gap: 4px;
            border: 1px solid #3f3f46; pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 9999999 !important; /* Critical: Controls always visible */
        }
        .selected .element-controls { display: flex; }

        /* Hide specific controls when locked */
        .locked .element-controls .btn-resize, 
        .locked .element-controls .btn-copy,
        .locked .resizer { display: none !important; }

        .control-btn {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; cursor: pointer; transition: 0.2s; color: white;
        }
        .btn-lock { background: #f59e0b; }
        .locked .btn-lock { background: #ef4444; }
        .btn-copy { background: #6366f1; }
        .btn-edit { background: var(--accent); } 
        .btn-del { background: #ef4444; }
        .control-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }

        .resizer {
            width: 10px; height: 10px; background: white; border: 1px solid var(--accent);
            position: absolute; bottom: -5px; right: -5px; cursor: se-resize; display: none;
            z-index: 9999999;
        }
        .selected .resizer { display: block; }

        .element-content { 
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            overflow: hidden; pointer-events: none;
        }

        #zoom-info {
            position: fixed; bottom: 15px; left: 65px;
            background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 4px;
            font-size: 11px; color: #aaa; pointer-events: none; border: 1px solid #333;
        }
        #shortcut-info {
            position: fixed; bottom: 15px; right: 15px;
            background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 4px;
            font-size: 11px; color: #aaa; pointer-events: none; border: 1px solid #333; text-align: right;
        }

        /* Modals */
        #setup-modal, #page-settings-modal, #page-manager-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; align-items: center; justify-content: center; 
        }
        #setup-modal { display: flex; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Startup Selection -->
    <div id="setup-modal">
        <div class="max-w-3xl w-full p-8 text-center">
            <h1 class="text-4xl font-black mb-10 italic uppercase tracking-tighter text-white">Studio<span class="text-blue-500">Pro</span></h1>
            <p class="text-slate-400 mb-8">Select Canvas Size</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div onclick="initProject('mobile')" class="p-6 bg-[#262626] rounded-xl cursor-pointer hover:border-blue-500 border-2 border-transparent transition group">
                    <i data-lucide="smartphone" class="mx-auto mb-3 w-8 h-8 text-slate-500 group-hover:text-blue-500"></i>
                    <span class="text-xs font-bold uppercase text-white">Mobile</span>
                </div>
                <div onclick="initProject('tablet')" class="p-6 bg-[#262626] rounded-xl cursor-pointer hover:border-blue-500 border-2 border-transparent transition group">
                    <i data-lucide="tablet" class="mx-auto mb-3 w-8 h-8 text-slate-500 group-hover:text-blue-500"></i>
                    <span class="text-xs font-bold uppercase text-white">Tablet</span>
                </div>
                <div onclick="initProject('desktop')" class="p-6 bg-[#262626] rounded-xl cursor-pointer hover:border-blue-500 border-2 border-transparent transition group">
                    <i data-lucide="monitor" class="mx-auto mb-3 w-8 h-8 text-slate-500 group-hover:text-blue-500"></i>
                    <span class="text-xs font-bold uppercase text-white">Desktop</span>
                </div>
                <div onclick="initProject('custom')" class="p-6 bg-[#262626] rounded-xl cursor-pointer hover:border-blue-500 border-2 border-transparent transition group">
                    <i data-lucide="maximize" class="mx-auto mb-3 w-8 h-8 text-slate-500 group-hover:text-blue-500"></i>
                    <span class="text-xs font-bold uppercase text-white">Custom</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Manager -->
    <div id="page-manager-modal">
        <div class="bg-[#262626] p-8 rounded-xl border border-[#3f3f46] w-96">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-white">Pages</h2><button onclick="togglePageManager()" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button></div>
            <div id="pages-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2"><input type="text" id="new-page-name" placeholder="Page Name" class="prop-input h-10"><button onclick="addNewPage()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-500">+</button></div>
        </div>
    </div>

    <!-- Global Settings -->
    <div id="page-settings-modal">
        <div class="bg-[#262626] p-8 rounded-xl border border-[#3f3f46] w-96 text-center">
            <h2 class="text-xl font-bold mb-6 text-blue-500">Project Config</h2>
            <div class="text-left mb-4">
                <label class="prop-title">View Mode (Export)</label>
                <select id="setting-scale-mode" class="prop-select">
                    <option value="fixed">Fixed Size (Centered)</option>
                    <option value="scale">Auto-Fit to Screen</option>
                </select>
            </div>
            <div class="text-left mb-4">
                <label class="prop-title">Background Color</label>
                <input type="color" id="setting-page-bg" class="prop-input h-10 p-1" value="#ffffff">
            </div>
            <button onclick="togglePageSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold mt-4">Close</button>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="h-[50px] bg-[#262626] border-b border-[#3f3f46] flex justify-between items-center px-4 z-[2500] fixed w-full top-0">
        <div class="flex items-center gap-4">
            <span class="font-bold text-lg tracking-tighter italic uppercase text-white">Studio<span class="text-blue-500">Pro</span></span>
            <div class="h-6 w-[1px] bg-[#3f3f46] mx-2"></div>
            <button onclick="togglePageManager()" class="px-3 py-1 bg-[#18181b] border border-[#3f3f46] text-white rounded text-xs font-bold flex items-center gap-2 hover:border-blue-500 transition">
                <i data-lucide="file" class="w-3 h-3 text-blue-400"></i><span id="current-page-display">Home</span><i data-lucide="chevron-down" class="w-3 h-3 text-slate-500"></i>
            </button>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="togglePageSettings()" class="p-2 text-slate-400 hover:text-white"><i data-lucide="settings" class="w-4 h-4"></i></button>
            <button onclick="exportCode()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold flex items-center gap-2"><i data-lucide="download" class="w-3 h-3"></i> Export</button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden h-screen pt-[50px]">
        
        <!-- Toolkit Sidebar -->
        <aside id="toolkit-sidebar">
            <div draggable="true" ondragstart="dragStart(event)" data-type="text" class="tool-item" data-label="Text"><i data-lucide="type" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="button" class="tool-item" data-label="Button"><i data-lucide="mouse-pointer-2" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="image" class="tool-item" data-label="Image"><i data-lucide="image" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="box" class="tool-item" data-label="Box"><i data-lucide="square" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="circle" class="tool-item" data-label="Circle"><i data-lucide="circle" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="input" class="tool-item" data-label="Input"><i data-lucide="text-cursor-input" class="w-5 h-5"></i></div>
            <div draggable="true" ondragstart="dragStart(event)" data-type="card" class="tool-item" data-label="Card"><i data-lucide="layout" class="w-5 h-5"></i></div>
            
            <div class="mt-auto mb-4 border-t border-[#3f3f46] w-8 pt-3 flex justify-center">
                 <button onclick="resetView()" title="Fit Screen" class="text-[10px] text-gray-400 font-bold border border-gray-600 rounded px-1 hover:text-white">100%</button>
            </div>
        </aside>

        <!-- Workspace Canvas -->
        <main id="workspace">
            <div id="zoom-wrapper">
                <div id="canvas" ondragover="allowDrop(event)" ondrop="dropElement(event)">
                    <div id="guide-layer"></div>
                </div>
            </div>
            <div id="zoom-info">Shift + Drag to Pan</div>
            <div id="shortcut-info">
                Ctrl + Click : Multi Select<br>
                Ctrl + G : Group Selection<br>
                Shift + } : Bring Front
            </div>
        </main>

        <!-- Properties Panel -->
        <aside id="properties">
            <div class="h-10 flex justify-between items-center px-4 bg-[#18181b] border-b border-[#3f3f46]">
                <span class="text-xs font-bold uppercase text-white">Properties</span>
                <button onclick="closePanel()" class="text-red-500 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 pb-10">
                <div class="prop-section text-center">
                    <span id="selection-count" class="text-xs text-slate-400">No Item Selected</span>
                </div>
                
                <div id="single-props">
                    <div class="prop-section">
                        <label class="prop-title text-yellow-500">Element ID</label>
                        <input type="text" id="prop-id" class="prop-input font-mono text-yellow-400" placeholder="unique_id">
                    </div>

                    <div class="prop-section">
                        <label class="prop-title">Transform</label>
                        <div class="prop-row">
                            <div><span class="text-[9px] text-gray-500">W</span><input type="number" id="prop-w" class="prop-input"></div>
                            <div><span class="text-[9px] text-gray-500">H</span><input type="number" id="prop-h" class="prop-input"></div>
                        </div>
                    </div>

                    <div class="prop-section">
                        <label class="prop-title">Content & Style</label>
                        <textarea id="prop-content" rows="3" class="prop-input" placeholder="Text content..."></textarea>
                        <div class="prop-row mt-2">
                            <div class="w-1/2">
                                <label class="text-[10px] text-gray-500">Text Color</label>
                                <input type="color" id="prop-color" class="w-full h-8 rounded bg-transparent border border-gray-600 cursor-pointer">
                            </div>
                            <div class="w-1/2">
                                <label class="text-[10px] text-gray-500">Background</label>
                                <input type="color" id="prop-bg" class="w-full h-8 rounded bg-transparent border border-gray-600 cursor-pointer">
                            </div>
                        </div>
                        <label class="text-[10px] text-gray-500 mt-2 block">Font Family</label>
                        <select id="prop-font" class="prop-select">
                            <option value="'Poppins', sans-serif">Poppins</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="serif">Serif</option>
                            <option value="monospace">Monospace</option>
                        </select>
                    </div>

                    <div class="prop-section">
                        <label class="prop-title">Decorations</label>
                        <label class="text-[10px] text-gray-500">Border Radius</label>
                        <input type="number" id="prop-radius" class="prop-input">
                    </div>

                    <div id="btn-settings" class="prop-section hidden">
                        <label class="prop-title text-blue-500">Link Actions</label>
                        <input type="text" id="prop-href" class="prop-input" placeholder="#PageID or https://...">
                        <select id="prop-target" class="prop-select">
                            <option value="_self">Same Tab</option>
                            <option value="_blank">New Tab</option>
                        </select>
                    </div>
                </div>

                <div class="prop-section">
                    <label class="prop-title">Layer (Z-Index)</label>
                    <div class="flex gap-2 mb-2">
                        <button onclick="changeZ(1)" class="w-1/2 bg-[#3f3f46] py-1 rounded text-[10px] hover:bg-white hover:text-black">Bring Forward</button>
                        <button onclick="changeZ(-1)" class="w-1/2 bg-[#3f3f46] py-1 rounded text-[10px] hover:bg-white hover:text-black">Send Backward</button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        lucide.createIcons();
        const canvas = document.getElementById('canvas');
        const zoomWrapper = document.getElementById('zoom-wrapper');
        const propertiesPanel = document.getElementById('properties');
        const workspace = document.getElementById('workspace');
        
        let pages = [];
        let currentPageId = null;
        let selectedElements = []; // Changed from single to array
        let zIndexCounter = 100;
        let viewState = { scale: 1, panX: 0, panY: 0, isPanning: false, startX: 0, startY: 0 };

        // --- KEYBOARD SHORTCUTS ---
        window.addEventListener('keydown', (e) => {
            if (selectedElements.length === 0) return;
            
            // SHIFT + } (Bring Forward)
            if (e.shiftKey && (e.key === '}' || e.key === ']' || e.code === 'BracketRight')) {
                e.preventDefault();
                changeZ(1);
            }
            // SHIFT + { (Send Backward)
            if (e.shiftKey && (e.key === '{' || e.key === '[' || e.code === 'BracketLeft')) {
                e.preventDefault();
                changeZ(-1);
            }
            // Delete
            if(e.key === 'Delete') {
                selectedElements.forEach(el => el.remove());
                selectedElements = [];
                closePanel();
            }
            // Group (Ctrl + G)
            if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'g') {
                e.preventDefault();
                groupSelection();
            }
        });

        // --- GLOBAL PAN & ZOOM ---
        function startPan(e) {
            e.preventDefault();
            viewState.isPanning = true;
            viewState.startX = e.clientX - viewState.panX;
            viewState.startY = e.clientY - viewState.panY;
            document.body.classList.add('is-panning');
        }
        workspace.addEventListener('mousedown', (e) => { if (e.shiftKey || e.button === 1) startPan(e); });
        window.addEventListener('mousemove', (e) => {
            if(viewState.isPanning) {
                e.preventDefault();
                viewState.panX = e.clientX - viewState.startX;
                viewState.panY = e.clientY - viewState.startY;
                updateTransform();
            }
        });
        window.addEventListener('mouseup', () => { viewState.isPanning = false; document.body.classList.remove('is-panning'); });
        workspace.addEventListener('wheel', (e) => {
            if(e.ctrlKey || e.metaKey || !viewState.isPanning) {
                e.preventDefault();
                const newScale = Math.min(Math.max(0.1, viewState.scale - (e.deltaY * 0.001)), 5.0);
                viewState.scale = newScale;
                updateTransform();
            }
        });
        function updateTransform() {
            zoomWrapper.style.transform = `translate(${viewState.panX}px, ${viewState.panY}px) scale(${viewState.scale})`;
            document.getElementById('zoom-info').innerText = `Zoom: ${Math.round(viewState.scale*100)}% (Shift+Drag to Pan)`;
        }
        function resetView() { viewState.scale = 0.8; viewState.panX = 0; viewState.panY = 0; updateTransform(); }

        // --- APP LOGIC ---
        function initProject(type) {
            canvas.style.borderRadius = '0px';
            if(type === 'mobile') { canvas.style.width = '375px'; canvas.style.height = '667px'; canvas.style.borderRadius = '0px'; }
            else if(type === 'tablet') { canvas.style.width = '768px'; canvas.style.height = '1024px'; }
            else if(type === 'desktop') { canvas.style.width = '1280px'; canvas.style.height = '800px'; }
            else { canvas.style.width = '1000px'; canvas.style.height = '600px'; }
            
            const initialPage = { id: 'page_' + Date.now(), name: 'Home', content: '' };
            pages.push(initialPage);
            currentPageId = initialPage.id;
            document.getElementById('setup-modal').style.display = 'none';
            renderPageList();
            resetView();
        }

        function togglePageManager() {
            const modal = document.getElementById('page-manager-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
            if(modal.style.display === 'flex') renderPageList();
        }
        function togglePageSettings() {
            const modal = document.getElementById('page-settings-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }
        function closePanel() { 
            propertiesPanel.classList.remove('open'); 
        }
        function openSidebar() { propertiesPanel.classList.add('open'); syncInputs(); }

        function renderPageList() {
            const list = document.getElementById('pages-list');
            list.innerHTML = '';
            pages.forEach((p, index) => {
                const isActive = p.id === currentPageId;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-2 rounded mb-1 border ${isActive ? 'border-blue-500 bg-blue-500/10' : 'border-transparent hover:bg-[#3f3f46]'}`;
                div.innerHTML = `<div class="cursor-pointer font-medium text-sm ${isActive?'text-white':'text-slate-400'}" onclick="switchPage('${p.id}')">${p.name}</div>`;
                list.appendChild(div);
            });
            document.getElementById('current-page-display').innerText = pages.find(p => p.id === currentPageId).name;
        }

        function saveCurrentPage() {
            document.querySelectorAll('.guide-line').forEach(g => g.remove());
            const page = pages.find(p => p.id === currentPageId);
            if(page) page.content = canvas.innerHTML;
        }

        function addNewPage() {
            const name = document.getElementById('new-page-name').value.trim() || `Page ${pages.length + 1}`;
            saveCurrentPage();
            const newPage = { id: 'page_' + Date.now(), name: name, content: '<div id="guide-layer"></div>' };
            pages.push(newPage);
            switchPage(newPage.id);
            document.getElementById('new-page-name').value = '';
        }

        function switchPage(id) {
            if(id === currentPageId) return;
            saveCurrentPage();
            deselectAll({target: workspace});
            currentPageId = id;
            const page = pages.find(p => p.id === id);
            canvas.innerHTML = page.content;
            if(!canvas.querySelector('#guide-layer')) canvas.appendChild(document.createElement('div')).id = 'guide-layer';
            rehydrateElements();
            renderPageList();
        }

        // --- DRAG & DROP ---
        function dragStart(e) { e.dataTransfer.setData("type", e.target.getAttribute('data-type')); }
        function allowDrop(e) { e.preventDefault(); }
        function dropElement(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / viewState.scale;
            const y = (e.clientY - rect.top) / viewState.scale;
            createWidget(e.dataTransfer.getData("type"), x, y);
        }

        function createWidget(type, x, y) {
            const elements = document.querySelectorAll('.builder-element');
            elements.forEach(el => {
                const z = parseInt(el.style.zIndex || 0);
                if(z >= zIndexCounter) zIndexCounter = z + 1;
            });

            const el = document.createElement('div');
            el.className = 'builder-element';
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.style.zIndex = zIndexCounter++;
            el.setAttribute('data-type', type);
            el.id = type + '_' + Math.random().toString(36).substr(2, 5);

            let inner = '', sw=200, sh=60;
            if(type === 'text') { inner = `<div class="element-content text-black text-xl font-bold" style="font-family: 'Poppins', sans-serif;">Edit Text</div>`; }
            else if(type === 'button') { inner = `<a href="#" class="element-content bg-blue-600 text-white rounded-lg font-bold flex items-center justify-center h-full w-full" style="text-decoration: none;">Button</a>`; sw=140; sh=45; }
            else if(type === 'image') { inner = `<img src="https://via.placeholder.com/300" class="element-content object-cover w-full h-full">`; sw=200; sh=150; }
            else if(type === 'box') { inner = `<div class="element-content border border-slate-300 bg-gray-100 w-full h-full"></div>`; sw=150; sh=150; }
            else if(type === 'circle') { inner = `<div class="element-content bg-red-500 rounded-full w-full h-full"></div>`; sw=100; sh=100; }
            else if(type === 'input') { inner = `<input placeholder="Enter text..." class="element-content border border-slate-300 rounded px-3 w-full h-full text-black">`; sw=220; sh=40; }
            else if(type === 'card') { inner = `<div class="element-content bg-white border border-slate-200 p-4 shadow-sm w-full h-full flex flex-col"><div class="h-24 bg-slate-100 mb-2 w-full"></div><div class="h-4 bg-slate-200 w-3/4"></div></div>`; sw=200; sh=250; }

            el.innerHTML = `
                <div class="element-controls">
                    <div class="control-btn btn-lock" title="Lock/Unlock"><i data-lucide="lock" class="w-4 h-4"></i></div>
                    <div class="control-btn btn-copy" title="Duplicate"><i data-lucide="copy" class="w-4 h-4"></i></div>
                    <div class="control-btn btn-edit" title="Properties"><i data-lucide="pencil" class="w-4 h-4"></i></div>
                    <div class="control-btn btn-del" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></div>
                </div>
                ${inner}
                <div class="resizer"></div>
            `;
            el.style.width = sw + 'px'; el.style.height = sh + 'px';
            attachListeners(el);
            canvas.appendChild(el);
            lucide.createIcons();
            selectElement(el, false);
        }

        // --- INTERACTION & GROUP LOGIC ---
        function attachListeners(el) {
            const btnLock = el.querySelector('.btn-lock');
            const btnCopy = el.querySelector('.btn-copy');
            const btnEdit = el.querySelector('.btn-edit');
            const btnDel = el.querySelector('.btn-del');

            if(btnLock) btnLock.addEventListener('mousedown', (e) => toggleLock(e, el));
            if(btnCopy) btnCopy.addEventListener('mousedown', (e) => duplicateEl(e, el));
            if(btnEdit) btnEdit.addEventListener('mousedown', (e) => { e.stopPropagation(); openSidebar(); });
            if(btnDel) btnDel.addEventListener('mousedown', (e) => deleteEl(e, el));

            el.addEventListener('mousedown', (e) => {
                if(e.shiftKey) { startPan(e); return; }
                if(e.target.closest('.element-controls') || e.target.classList.contains('resizer')) return;
                
                e.stopPropagation();
                
                // Multi Select Logic
                const isMulti = e.ctrlKey || e.metaKey;
                selectElement(el, isMulti);
                
                // If not locked, start move
                if(!el.classList.contains('locked')) {
                    startMove(e, el);
                }
            });

            const resizer = el.querySelector('.resizer');
            if(resizer) resizer.addEventListener('mousedown', (e) => { 
                e.stopPropagation(); 
                if(!el.classList.contains('locked')) startResize(e, el); 
            });
        }

        function toggleLock(e, el) {
            e.stopPropagation();
            el.classList.toggle('locked');
            const icon = el.querySelector('.btn-lock i');
            // Visual toggle (using Lucide classes re-render or just simple class switch if icon swap needed)
            // Ideally we re-render icon, but simple color change via CSS is handled.
            selectElement(el, false); // re-trigger selection to update UI
        }

        function rehydrateElements() { canvas.querySelectorAll('.builder-element').forEach(el => attachListeners(el)); lucide.createIcons(); }
        
        // --- SELECTION LOGIC ---
        function selectElement(el, multi) {
            // Check for Group ID
            const groupId = el.getAttribute('data-group');
            let elementsToSelect = [el];
            
            // If part of a group, select all peers
            if(groupId) {
                elementsToSelect = Array.from(document.querySelectorAll(`.builder-element[data-group="${groupId}"]`));
            }

            if (!multi) {
                // Clear previous
                selectedElements.forEach(item => item.classList.remove('selected'));
                selectedElements = [];
                // Add new
                elementsToSelect.forEach(item => {
                    selectedElements.push(item);
                    item.classList.add('selected');
                });
            } else {
                // Toggle selection
                elementsToSelect.forEach(item => {
                    if(selectedElements.includes(item)) {
                        item.classList.remove('selected');
                        selectedElements = selectedElements.filter(x => x !== item);
                    } else {
                        selectedElements.push(item);
                        item.classList.add('selected');
                    }
                });
            }
            
            updateUIState();
        }

        function deselectAll(e) { 
            if(e.target.id === 'workspace' || e.target.id === 'canvas' || e.target.id === 'zoom-wrapper') { 
                selectedElements.forEach(item => item.classList.remove('selected'));
                selectedElements = [];
                closePanel();
                updateUIState();
            } 
        }

        function updateUIState() {
            const count = selectedElements.length;
            document.getElementById('selection-count').innerText = count > 0 ? `${count} Item(s) Selected` : "No Item Selected";
            
            if(count === 1) {
                document.getElementById('single-props').classList.remove('hidden');
                syncInputs(); // Sync the single selected item
                openSidebar();
            } else {
                document.getElementById('single-props').classList.add('hidden');
                if(count > 0) openSidebar(); else closePanel();
            }
        }

        function groupSelection() {
            if(selectedElements.length < 2) return;
            const groupId = 'g_' + Date.now();
            selectedElements.forEach(el => el.setAttribute('data-group', groupId));
            alert('Items Grouped!');
        }

        function deleteEl(e, el) { 
            e.stopPropagation(); 
            // If grouped, delete all
            const groupId = el.getAttribute('data-group');
            if(groupId) {
                 document.querySelectorAll(`.builder-element[data-group="${groupId}"]`).forEach(g => g.remove());
            } else {
                el.remove(); 
            }
            selectedElements = [];
            closePanel(); 
        }
        
        function duplicateEl(e, el) { 
            e.stopPropagation(); 
            // If grouped, duplicate entire group logic is complex, for now duplicate single
            // Simple duplication for single items
            const clone = el.cloneNode(true); 
            clone.id = el.getAttribute('data-type') + '_' + Math.random().toString(36).substr(2, 5); 
            clone.style.left = (parseFloat(el.style.left)+20)+'px'; 
            clone.style.top = (parseFloat(el.style.top)+20)+'px'; 
            clone.style.zIndex = ++zIndexCounter; 
            clone.classList.remove('selected', 'locked'); 
            clone.removeAttribute('data-group'); // Don't clone group ID immediately
            attachListeners(clone); 
            canvas.appendChild(clone); 
            selectElement(clone, false); 
            lucide.createIcons(); 
        }

        // --- MOVING ELEMENTS (Multi-Move) ---
        function startMove(e, el) {
            const startX = e.clientX, startY = e.clientY;
            
            // Store initial positions of ALL selected elements
            const initialPositions = selectedElements.map(item => ({
                el: item,
                startX: parseFloat(item.style.left),
                startY: parseFloat(item.style.top)
            }));

            const move = (e) => {
                const dx = (e.clientX - startX) / viewState.scale;
                const dy = (e.clientY - startY) / viewState.scale;
                
                initialPositions.forEach(p => {
                    p.el.style.left = (p.startX + dx) + 'px';
                    p.el.style.top = (p.startY + dy) + 'px';
                });
            };

            const stop = () => { 
                window.removeEventListener('mousemove', move); 
                window.removeEventListener('mouseup', stop); 
            };
            window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
        }

        function startResize(e, el) {
            const startX = e.clientX, startY = e.clientY, sw = el.offsetWidth, sh = el.offsetHeight;
            const resize = (e) => { 
                el.style.width = (sw + (e.clientX - startX) / viewState.scale) + 'px'; 
                el.style.height = (sh + (e.clientY - startY) / viewState.scale) + 'px'; 
            };
            window.addEventListener('mousemove', resize); window.addEventListener('mouseup', () => window.removeEventListener('mousemove', resize), {once:true});
        }

        // --- PROPERTIES ---
        function syncInputs() {
            if(selectedElements.length !== 1) return;
            const el = selectedElements[0];
            const content = el.querySelector('.element-content');
            const type = el.getAttribute('data-type');
            
            document.getElementById('prop-id').value = el.id;
            document.getElementById('prop-w').value = parseInt(el.style.width);
            document.getElementById('prop-h').value = parseInt(el.style.height);
            
            if(type === 'image') document.getElementById('prop-content').value = content.src;
            else if(type === 'input') document.getElementById('prop-content').value = content.placeholder;
            else document.getElementById('prop-content').value = content.innerText;

            const comp = window.getComputedStyle(content);
            document.getElementById('prop-bg').value = rgbToHex(comp.backgroundColor);
            document.getElementById('prop-color').value = rgbToHex(comp.color);
            document.getElementById('prop-radius').value = parseInt(comp.borderRadius) || 0;
            document.getElementById('prop-font').value = content.style.fontFamily.replace(/"/g,"'") || "'Poppins', sans-serif";

            const btnSet = document.getElementById('btn-settings');
            if(type === 'button' && content.tagName === 'A') {
                btnSet.classList.remove('hidden');
                document.getElementById('prop-href').value = content.getAttribute('href');
                document.getElementById('prop-target').value = content.getAttribute('target') || "_self";
            } else {
                btnSet.classList.add('hidden');
            }
        }

        // Input listeners
        document.getElementById('prop-id').addEventListener('change', e => { if(selectedElements.length===1) selectedElements[0].id = e.target.value; });
        ['prop-w', 'prop-h'].forEach(id => document.getElementById(id).addEventListener('input', e => { 
            if(selectedElements.length===1) id==='prop-w' ? selectedElements[0].style.width = e.target.value+'px' : selectedElements[0].style.height = e.target.value+'px'; 
        }));
        // Apply Color/BG/Font to ALL selected
        document.getElementById('prop-bg').addEventListener('input', e => { selectedElements.forEach(el => el.querySelector('.element-content').style.backgroundColor = e.target.value); });
        document.getElementById('prop-color').addEventListener('input', e => { selectedElements.forEach(el => el.querySelector('.element-content').style.color = e.target.value); });
        document.getElementById('prop-radius').addEventListener('input', e => { selectedElements.forEach(el => el.querySelector('.element-content').style.borderRadius = e.target.value+'px'); });
        document.getElementById('prop-font').addEventListener('change', e => { selectedElements.forEach(el => el.querySelector('.element-content').style.fontFamily = e.target.value); });
        
        document.getElementById('prop-content').addEventListener('input', e => {
            if(selectedElements.length !== 1) return;
            const c = selectedElements[0].querySelector('.element-content');
            if(c.tagName === 'IMG') c.src = e.target.value; else if(c.tagName === 'INPUT') c.placeholder = e.target.value; else c.innerText = e.target.value;
        });

        function changeZ(v) { 
            selectedElements.forEach(el => {
                let currentZ = parseInt(el.style.zIndex || 0);
                el.style.zIndex = currentZ + v;
            });
        }
        function rgbToHex(rgb) { if(!rgb || rgb==='rgba(0, 0, 0, 0)') return '#000000'; if(rgb.startsWith('#')) return rgb; const [r,g,b] = rgb.match(/\d+/g); return "#" + ((1 << 24) + (+r << 16) + (+g << 8) + +b).toString(16).slice(1); }

        // --- EXPORT ---
        function exportCode() {
            saveCurrentPage();
            const scaleMode = document.getElementById('setting-scale-mode').value;
            const bg = document.getElementById('setting-page-bg').value;
            let allPagesHtml = '';
            
            pages.forEach((page, index) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = page.content;
                tempDiv.querySelectorAll('.element-controls, .resizer, .guide-line, #guide-layer').forEach(e => e.remove());
                tempDiv.querySelectorAll('.builder-element').forEach(el => {
                    el.classList.remove('selected', 'locked'); 
                    el.style.border = 'none';
                    if(el.querySelector('.element-content')) el.querySelector('.element-content').style.pointerEvents = 'auto';
                });
                const safeName = page.name.replace(/\s+/g, '');
                allPagesHtml += `<div id="${safeName}" class="spa-page" style="display: ${index===0?'block':'none'}; position: relative; width: 100%; height: 100%;">${tempDiv.innerHTML}</div>`;
            });

            // Restore guide layer
            const g = document.createElement('div'); g.id = 'guide-layer'; canvas.appendChild(g);

            let bodyStyle = `margin:0;background:${bg};min-height:100vh;`;
            let containerStyle = `position:relative;width:${canvas.offsetWidth}px;height:${canvas.offsetHeight}px;background:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.5);overflow:hidden;`;
            let extraScript = '';

            if (scaleMode === 'fixed') {
                bodyStyle += `display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;`;
                containerStyle += `flex-shrink:0;${canvas.style.borderRadius ? `border-radius:${canvas.style.borderRadius};` : ''}`;
            } else if (scaleMode === 'scale') {
                bodyStyle += `overflow:hidden;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;`;
                containerStyle += `transform-origin: center center; position: absolute;`;
                extraScript = `<script>function resize(){const c=document.querySelector('.page-container');if(!c)return;const cw=${canvas.offsetWidth},ch=${canvas.offsetHeight},ww=window.innerWidth,wh=window.innerHeight,s=Math.min(ww/cw,wh/ch);c.style.transform='scale('+s+')'}window.addEventListener('resize',resize);window.addEventListener('load',resize);<\/script>`;
            }

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Export</title><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet"><script src="https://cdn.tailwindcss.com"><\/script><style>body{${bodyStyle}}.page-container{${containerStyle}}.builder-element{position:absolute}.element-content{width:100%;height:100%;display:flex;align-items:center;justify-content:center;text-decoration:none}</style></head><body><div class="page-container">${allPagesHtml}</div><script>function navigateTo(p){document.querySelectorAll('.spa-page').forEach(e=>e.style.display='none');const t=document.getElementById(p);if(t)t.style.display='block'}document.addEventListener('click',e=>{if(e.target.tagName==='A'&&e.target.getAttribute('href').startsWith('#')){e.preventDefault();navigateTo(e.target.getAttribute('href').substring(1))}})<\/script>${extraScript}</body></html>`;
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([html], {type: 'text/html'}));
            a.download = 'project_export.html'; a.click();
        }
    </script>
</body>
</html>

<!-- START OF FILE index.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudioPro Elite V12 - SPA Export & Zoom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #22c55e;
            --bg-dark: #020617;
            --panel-bg: #0f172a;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg-dark); 
            color: #f8fafc; 
            margin: 0; height: 100vh;
            overflow: hidden;
        }

        /* --- UI Layers (Sidebars) --- */
        #toolkit-sidebar { 
            width: 260px; position: fixed; left: -260px; top: 64px; bottom: 0; 
            z-index: 2000; background: var(--panel-bg); border-right: 1px solid rgba(255,255,255,0.1);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        #toolkit-sidebar.open { left: 0; }

        #properties {
            width: 280px; background: var(--panel-bg); border-left: 1px solid rgba(255,255,255,0.1);
            position: fixed; right: -280px; top: 0; bottom: 0; z-index: 2000; 
            display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #properties.open { right: 0; }

        .sidebar-content { overflow-y: auto; flex: 1; padding: 15px; }
        .sidebar-content::-webkit-scrollbar { width: 4px; }
        .sidebar-content::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        /* --- Workspace Centering Engine (UPDATED for Zoom) --- */
        #workspace {
            position: absolute;
            top: 64px; bottom: 0; left: 0; right: 0;
            overflow: hidden; /* Scroll handled by content wrapper if needed, but zoom makes it easier */
            background-image: radial-gradient(rgba(255, 255, 255, 0.03) 1.5px, transparent 1.5px);
            background-size: 25px 25px;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: left 0.4s, right 0.4s;
            padding: 20px;
        }

        /* Responsive Layout Adjustments */
        body.sidebar-open #workspace { left: 260px; }
        body.props-open #workspace { right: 280px; }

        /* Zoom Container to handle scaling smoothly */
        #zoom-wrapper {
            transition: transform 0.2s ease-out;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        }

        #canvas {
            background: #ffffff;
            position: relative; 
            transition: width 0.3s, height 0.3s;
            flex-shrink: 0; 
        }

        /* --- Builder Elements & Controls --- */
        .builder-element { position: absolute; cursor: grab; box-sizing: border-box; border: 2px solid transparent; }
        .builder-element.selected { border-color: var(--accent); z-index: 1000 !important; }

        .element-controls {
            position: absolute; top: -50px; left: 0;
            background: #1e293b; padding: 4px; border-radius: 8px; display: none; gap: 4px;
            border: 1px solid #334155; box-shadow: 0 10px 15px rgba(0,0,0,0.3);
            pointer-events: auto; z-index: 1001;
            transform: scale(1) !important; /* Keep controls same size regardless of canvas zoom */
        }
        .selected .element-controls { display: flex; }

        .control-btn {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-copy { background: #6366f1; color: white; }
        .btn-del { background: #ef4444; color: white; }

        .resizer {
            width: 12px; height: 12px; background: var(--accent); border: 2px solid white;
            position: absolute; bottom: -6px; right: -6px; border-radius: 50%; cursor: se-resize; display: none;
        }
        .selected .resizer { display: block; }

        .element-content { 
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            overflow: hidden; text-decoration: none; pointer-events: none;
        }

        /* Toolkit Items */
        .tool-item {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px; padding: 12px; margin-bottom: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: grab; transition: 0.2s;
        }
        .tool-item:hover { background: var(--accent); color: white; transform: translateY(-2px); }

        .prop-input, .prop-select {
            width: 100%; background: #020617; border: 1px solid #334155;
            color: white; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 4px;
        }

        /* Zoom Controls */
        #zoom-controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 12px;
            z-index: 2500; backdrop-filter: blur(5px);
        }

        /* Modals */
        #setup-modal, #page-settings-modal, #page-manager-modal { 
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 3000; display: none; align-items: center; justify-content: center; 
        }
        #setup-modal { display: flex; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Startup Selection -->
    <div id="setup-modal">
        <div class="max-w-2xl w-full p-6 text-center">
            <h1 class="text-3xl font-black mb-8 italic uppercase tracking-tighter">Studio<span class="text-green-500">Pro</span></h1>
            <p class="text-slate-400 mb-6">Select your initial canvas size</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div onclick="initProject('mobile')" class="p-6 bg-slate-900 rounded-3xl cursor-pointer hover:border-green-500 border-2 border-transparent transition group">
                    <i data-lucide="smartphone" class="mx-auto mb-2 w-8 h-8 text-slate-500 group-hover:text-green-500"></i>
                    <span class="text-xs font-bold uppercase">Mobile</span>
                </div>
                <div onclick="initProject('tablet')" class="p-6 bg-slate-900 rounded-3xl cursor-pointer hover:border-green-500 border-2 border-transparent transition group">
                    <i data-lucide="tablet" class="mx-auto mb-2 w-8 h-8 text-slate-500 group-hover:text-green-500"></i>
                    <span class="text-xs font-bold uppercase">Tablet</span>
                </div>
                <div onclick="initProject('desktop')" class="p-6 bg-slate-900 rounded-3xl cursor-pointer hover:border-green-500 border-2 border-transparent transition group">
                    <i data-lucide="monitor" class="mx-auto mb-2 w-8 h-8 text-slate-500 group-hover:text-green-500"></i>
                    <span class="text-xs font-bold uppercase">Desktop</span>
                </div>
                <div onclick="initProject('custom')" class="p-6 bg-slate-900 rounded-3xl cursor-pointer hover:border-green-500 border-2 border-transparent transition group">
                    <i data-lucide="maximize" class="mx-auto mb-2 w-8 h-8 text-slate-500 group-hover:text-green-500"></i>
                    <span class="text-xs font-bold uppercase">Custom</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Manager Modal -->
    <div id="page-manager-modal">
        <div class="bg-slate-900 p-8 rounded-3xl border border-white/10 w-96">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Pages</h2>
                <button onclick="togglePageManager()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="pages-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-2"></div>
            <div class="pt-4 border-t border-white/10">
                <div class="flex gap-2">
                    <input type="text" id="new-page-name" placeholder="Page Name (e.g. About)" class="prop-input h-10">
                    <button onclick="addNewPage()" class="bg-green-600 hover:bg-green-500 text-white px-4 rounded-lg font-bold text-xs"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Settings -->
    <div id="page-settings-modal">
        <div class="bg-slate-900 p-8 rounded-3xl border border-white/10 w-96 text-center">
            <h2 class="text-xl font-bold mb-6 text-green-500">Project Config</h2>
            <div class="space-y-4">
                <div class="text-left">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Screen Scaling</label>
                    <select id="setting-scale-mode" class="prop-select mt-2">
                        <option value="fixed">Fixed (Centered)</option>
                        <option value="scale">Auto-Scale (TV/Large Screen)</option>
                    </select>
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Global Background</label>
                    <input type="color" id="setting-page-bg" class="prop-input h-10 p-1" value="#020617">
                </div>
            </div>
            <button onclick="togglePageSettings()" class="w-full mt-8 bg-green-600 py-3 rounded-xl font-bold">Close</button>
        </div>
    </div>

    <!-- Header Navigation -->
    <nav class="h-16 bg-slate-950 border-b border-white/5 flex justify-between items-center px-6 z-[2500] fixed w-full top-0">
        <div class="flex items-center gap-4">
            <button onclick="toggleToolkit()" class="p-2 bg-green-500/10 text-green-500 rounded-lg hover:bg-green-500 hover:text-white transition">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
            </button>
            <span class="font-bold text-lg tracking-tighter italic uppercase hidden md:inline">Studio<span class="text-green-500">Pro</span></span>
            
            <button onclick="togglePageManager()" class="ml-4 px-4 py-2 bg-slate-800 border border-slate-700 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition flex items-center gap-2">
                <i data-lucide="file" class="w-4 h-4 text-blue-400"></i>
                <span id="current-page-display">Home</span>
                <i data-lucide="chevron-down" class="w-3 h-3 text-slate-500"></i>
            </button>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="togglePageSettings()" class="p-2 bg-slate-800 text-slate-300 rounded-full hover:bg-slate-700 transition">
                <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
            <button onclick="exportCode()" class="bg-green-600 hover:bg-green-500 text-white px-5 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-green-600/20">
                <i data-lucide="download" class="w-4 h-4"></i> Export All
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden h-screen pt-16">
        
        <!-- Toolkit Sidebar -->
        <aside id="toolkit-sidebar">
            <div class="p-4 border-b border-white/5 flex justify-between items-center">
                <span class="text-xs font-bold uppercase text-slate-500 tracking-widest">Components</span>
                <button onclick="toggleToolkit()" class="text-slate-400"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="sidebar-content">
                <div draggable="true" ondragstart="dragStart(event)" data-type="text" class="tool-item"><i data-lucide="type" class="text-blue-400"></i><span>Text</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="button" class="tool-item"><i data-lucide="mouse-pointer" class="text-green-400"></i><span>Button</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="image" class="tool-item"><i data-lucide="image" class="text-purple-400"></i><span>Image</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="box" class="tool-item"><i data-lucide="square" class="text-orange-400"></i><span>Div Box</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="circle" class="tool-item"><i data-lucide="circle" class="text-pink-400"></i><span>Circle</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="input" class="tool-item"><i data-lucide="text-cursor-input" class="text-yellow-400"></i><span>Input</span></div>
                <div draggable="true" ondragstart="dragStart(event)" data-type="card" class="tool-item"><i data-lucide="layout" class="text-teal-400"></i><span>Card</span></div>
            </div>
        </aside>

        <!-- Workspace -->
        <main id="workspace" onclick="deselectAll(event)">
            <!-- Wrapper for Zooming -->
            <div id="zoom-wrapper">
                <div id="canvas" ondragover="allowDrop(event)" ondrop="dropElement(event)"></div>
            </div>
        </main>

        <!-- Zoom Controls -->
        <div id="zoom-controls">
            <button onclick="zoomCanvas(-0.1)" class="text-slate-400 hover:text-white"><i data-lucide="minus" class="w-4 h-4"></i></button>
            <span id="zoom-val" class="text-xs font-bold text-white w-8 text-center">100%</span>
            <button onclick="zoomCanvas(0.1)" class="text-slate-400 hover:text-white"><i data-lucide="plus" class="w-4 h-4"></i></button>
        </div>

        <!-- Properties Panel -->
        <aside id="properties">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-slate-950">
                <span class="text-xs font-bold uppercase text-slate-400">Edit Settings</span>
                <button onclick="closePanel()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <div>
                    <label id="content-label" class="text-[10px] font-bold text-slate-500 uppercase">Content / Image URL</label>
                    <textarea id="prop-content" rows="2" class="prop-input"></textarea>
                </div>
                <div id="btn-settings" class="hidden p-3 bg-green-500/5 rounded-xl border border-green-500/10 space-y-3">
                    <p class="text-[10px] font-bold text-green-500 uppercase">Link (Use #PageName)</p>
                    <input type="text" id="prop-href" class="prop-input" placeholder="#About">
                    <select id="prop-target" class="prop-select">
                        <option value="_self">Same Tab</option>
                        <option value="_blank">New Tab</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Width</label><input type="number" id="prop-w" class="prop-input"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Height</label><input type="number" id="prop-h" class="prop-input"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Text Color</label><input type="color" id="prop-color" class="prop-input h-10 p-1"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase">Background</label><input type="color" id="prop-bg" class="prop-input h-10 p-1"></div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-500 uppercase">Border Radius</label><input type="number" id="prop-radius" class="prop-input"></div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Font</label>
                    <select id="prop-font" class="prop-select">
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                    </select>
                </div>
                <div class="pt-4 border-t border-white/5 space-y-2">
                    <button onclick="changeZ(10)" class="w-full bg-slate-800 py-2 rounded-lg text-xs font-bold">Bring Front</button>
                    <button onclick="changeZ(-10)" class="w-full bg-slate-800 py-2 rounded-lg text-xs font-bold">Send Back</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        lucide.createIcons();
        const canvas = document.getElementById('canvas');
        const zoomWrapper = document.getElementById('zoom-wrapper');
        const propertiesPanel = document.getElementById('properties');
        const toolkitSidebar = document.getElementById('toolkit-sidebar');
        const settingsModal = document.getElementById('page-settings-modal');
        const pageManagerModal = document.getElementById('page-manager-modal');
        
        // State
        let pages = [];
        let currentPageId = null;
        let selectedElement = null;
        let zIndexCounter = 1000;
        let currentZoom = 1;

        // --- Layout & Zoom Functions ---
        function toggleToolkit() { 
            toolkitSidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }

        function togglePageSettings() { settingsModal.style.display = (settingsModal.style.display === 'flex') ? 'none' : 'flex'; }
        
        function togglePageManager() {
            pageManagerModal.style.display = (pageManagerModal.style.display === 'flex') ? 'none' : 'flex';
            if(pageManagerModal.style.display === 'flex') renderPageList();
        }

        function closePanel() { 
            propertiesPanel.classList.remove('open');
            document.body.classList.remove('props-open');
        }

        function zoomCanvas(change) {
            currentZoom += change;
            if(currentZoom < 0.2) currentZoom = 0.2;
            if(currentZoom > 2.0) currentZoom = 2.0;
            zoomWrapper.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoom-val').innerText = Math.round(currentZoom * 100) + '%';
        }

        // --- Initialization ---
        function initProject(type) {
            canvas.style.borderRadius = '0px';
            if(type === 'mobile') { canvas.style.width = '375px'; canvas.style.height = '667px'; canvas.style.borderRadius = '20px'; }
            else if(type === 'tablet') { canvas.style.width = '700px'; canvas.style.height = '900px'; canvas.style.borderRadius = '15px'; }
            else if(type === 'desktop') { canvas.style.width = '1200px'; canvas.style.height = '800px'; }
            else { canvas.style.width = '1000px'; canvas.style.height = '600px'; }
            
            // Adjust zoom automatically for smaller screens on init
            if(window.innerHeight < 800) zoomCanvas(-0.2);

            const initialPage = { id: 'page_' + Date.now(), name: 'Home', content: '' };
            pages.push(initialPage);
            currentPageId = initialPage.id;
            
            document.getElementById('setup-modal').style.display = 'none';
            renderPageList();
        }

        // --- Multi-Page Logic ---
        function renderPageList() {
            const list = document.getElementById('pages-list');
            list.innerHTML = '';
            pages.forEach((p, index) => {
                const isActive = p.id === currentPageId;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 rounded-lg border ${isActive ? 'border-green-500 bg-green-500/10' : 'border-white/5 bg-slate-800'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="switchPage('${p.id}')">
                        <i data-lucide="${index === 0 ? 'home' : 'file'}" class="w-4 h-4 ${isActive ? 'text-green-500' : 'text-slate-500'}"></i>
                        <span class="text-sm font-bold ${isActive ? 'text-white' : 'text-slate-400'}">${p.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="renamePage('${p.id}')" class="p-1 hover:text-blue-400 text-slate-500"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        ${pages.length > 1 ? `<button onclick="deletePage('${p.id}')" class="p-1 hover:text-red-400 text-slate-500"><i data-lucide="trash" class="w-3 h-3"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
            document.getElementById('current-page-display').innerText = pages.find(p => p.id === currentPageId).name;
        }

        function saveCurrentPage() {
            const page = pages.find(p => p.id === currentPageId);
            if(page) page.content = canvas.innerHTML;
        }

        function addNewPage() {
            const input = document.getElementById('new-page-name');
            const name = input.value.trim() || `Page ${pages.length + 1}`;
            saveCurrentPage();
            const newPage = { id: 'page_' + Date.now(), name: name, content: '' };
            pages.push(newPage);
            input.value = '';
            switchPage(newPage.id);
        }

        function switchPage(id) {
            if(id === currentPageId) return;
            saveCurrentPage();
            deselectAll({target: document.getElementById('workspace')});
            currentPageId = id;
            const page = pages.find(p => p.id === id);
            canvas.innerHTML = page.content;
            rehydrateElements();
            renderPageList();
            document.getElementById('current-page-display').innerText = page.name;
        }

        function renamePage(id) {
            const newName = prompt("Enter new page name:");
            if(newName) {
                pages.find(p => p.id === id).name = newName;
                renderPageList();
                document.getElementById('current-page-display').innerText = pages.find(p => p.id === currentPageId).name;
            }
        }

        function deletePage(id) {
            if(confirm("Delete this page?")) {
                const index = pages.findIndex(p => p.id === id);
                pages.splice(index, 1);
                if(id === currentPageId) {
                    currentPageId = pages[0].id;
                    canvas.innerHTML = pages[0].content;
                    rehydrateElements();
                }
                renderPageList();
            }
        }

        // --- Drag & Drop Core ---
        function dragStart(e) { e.dataTransfer.setData("type", e.target.getAttribute('data-type')); }
        function allowDrop(e) { e.preventDefault(); }
        function dropElement(e) {
            e.preventDefault();
            // Need to account for zoom when dropping
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / currentZoom;
            const y = (e.clientY - rect.top) / currentZoom;
            createWidget(e.dataTransfer.getData("type"), x, y);
        }

        function createWidget(type, x, y) {
            const el = document.createElement('div');
            el.className = 'builder-element';
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.style.zIndex = ++zIndexCounter;
            el.setAttribute('data-type', type);

            let inner = '';
            let sw=200, sh=50;

            if(type === 'text') inner = `<div class="element-content text-black text-xl font-bold">Edit Text</div>`;
            else if(type === 'button') { inner = `<a href="#" class="element-content bg-green-600 text-white px-6 rounded-lg font-bold">Button</a>`; sw=150; sh=45; }
            else if(type === 'image') { inner = `<img src="https://via.placeholder.com/300" class="element-content object-cover rounded-lg">`; sw=250; sh=150; }
            else if(type === 'box') { inner = `<div class="element-content border border-slate-300 rounded-md"></div>`; sw=150; sh=150; }
            else if(type === 'circle') { inner = `<div class="element-content bg-blue-500 rounded-full"></div>`; sw=100; sh=100; }
            else if(type === 'input') { inner = `<input placeholder="Type..." class="element-content border border-slate-300 rounded-lg px-4 text-black">`; sw=250; sh=45; }
            else if(type === 'card') { inner = `<div class="element-content bg-white border border-slate-200 rounded-2xl p-4 flex flex-col shadow-sm"><div class="w-full h-20 bg-slate-100 rounded-xl mb-2"></div><div class="h-3 w-3/4 bg-slate-200 rounded"></div></div>`; sw=200; sh=240; }

            el.innerHTML = `
                <div class="element-controls">
                    <div class="control-btn btn-copy" onclick="duplicateEl(event, this.parentElement.parentElement)"><i data-lucide="copy" class="w-4 h-4"></i></div>
                    <div class="control-btn btn-edit" onclick="openSidebar(event, this.parentElement.parentElement)"><i data-lucide="pencil" class="w-4 h-4"></i></div>
                    <div class="control-btn btn-del" onclick="deleteEl(event, this.parentElement.parentElement)"><i data-lucide="trash-2" class="w-4 h-4"></i></div>
                </div>
                ${inner}
                <div class="resizer"></div>
            `;

            el.style.width = sw + 'px'; el.style.height = sh + 'px';
            attachListeners(el);
            canvas.appendChild(el);
            lucide.createIcons();
            selectElement(el);
        }

        // --- Event Listeners Management ---
        function attachListeners(el) {
            el.addEventListener('mousedown', (e) => {
                if(e.target.closest('.element-controls') || e.target.classList.contains('resizer')) return;
                selectElement(el);
                startDrag(e, el);
            });
            const resizer = el.querySelector('.resizer');
            if(resizer) resizer.addEventListener('mousedown', (e) => { e.stopPropagation(); startResize(e, el); });
        }

        function rehydrateElements() {
            const elements = canvas.querySelectorAll('.builder-element');
            elements.forEach(el => attachListeners(el));
            lucide.createIcons();
        }

        // --- Interaction Logic ---
        function selectElement(el) {
            if(selectedElement) selectedElement.classList.remove('selected');
            selectedElement = el;
            selectedElement.classList.add('selected');
        }

        function deselectAll(e) {
            if(e.target.id === 'workspace' || e.target.id === 'canvas' || e.target.id === 'zoom-wrapper') {
                if(selectedElement) selectedElement.classList.remove('selected');
                selectedElement = null;
                closePanel();
            }
        }

        function openSidebar(e, el) {
            e.stopPropagation();
            selectElement(el);
            propertiesPanel.classList.add('open');
            document.body.classList.add('props-open');
            syncInputs();
        }

        function deleteEl(e, el) { e.stopPropagation(); el.remove(); closePanel(); }

        function syncInputs() {
            if(!selectedElement) return;
            const content = selectedElement.querySelector('.element-content');
            const type = selectedElement.getAttribute('data-type');
            document.getElementById('prop-w').value = parseInt(selectedElement.style.width);
            document.getElementById('prop-h').value = parseInt(selectedElement.style.height);
            document.getElementById('btn-settings').style.display = (type === 'button') ? 'block' : 'none';
            
            if(type === 'image') {
                document.getElementById('prop-content').value = content.src;
                document.getElementById('content-label').innerText = "IMAGE URL";
            } else {
                document.getElementById('prop-content').value = content.innerText || content.placeholder || "";
                document.getElementById('content-label').innerText = "CONTENT / TEXT";
            }
            if(type === 'button' && content.tagName === 'A') {
                document.getElementById('prop-href').value = content.getAttribute('href');
            }
        }

        function duplicateEl(e, el) {
            e.stopPropagation();
            const clone = el.cloneNode(true);
            clone.style.left = (parseInt(el.style.left) + 20) + 'px';
            clone.style.top = (parseInt(el.style.top) + 20) + 'px';
            clone.style.zIndex = ++zIndexCounter;
            clone.classList.remove('selected');
            attachListeners(clone);
            canvas.appendChild(clone);
            selectElement(clone);
            lucide.createIcons();
        }

        ['prop-w', 'prop-h', 'prop-bg', 'prop-color', 'prop-radius', 'prop-font', 'prop-href', 'prop-target'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                if(!selectedElement) return;
                const v = e.target.value;
                const target = selectedElement.querySelector('.element-content');
                if(id === 'prop-w') selectedElement.style.width = v + 'px';
                if(id === 'prop-h') selectedElement.style.height = v + 'px';
                if(id === 'prop-bg') target.style.backgroundColor = v;
                if(id === 'prop-color') target.style.color = v;
                if(id === 'prop-radius') target.style.borderRadius = v + 'px';
                if(id === 'prop-font') target.style.fontFamily = v;
                if(id === 'prop-href' && target.tagName === 'A') target.setAttribute('href', v);
                if(id === 'prop-target' && target.tagName === 'A') target.setAttribute('target', v);
            });
        });

        document.getElementById('prop-content').addEventListener('input', (e) => {
            if(!selectedElement) return;
            const target = selectedElement.querySelector('.element-content');
            if(target.tagName === 'IMG') target.src = e.target.value;
            else if(target.tagName === 'INPUT') target.placeholder = e.target.value;
            else target.innerText = e.target.value;
        });

        function changeZ(v) { if(selectedElement) selectedElement.style.zIndex = parseInt(selectedElement.style.zIndex) + v; }

        function startDrag(e, el) {
            const ox = e.clientX - el.offsetLeft * currentZoom, oy = e.clientY - el.offsetTop * currentZoom;
            const move = (e) => { 
                el.style.left = (e.clientX - ox) / currentZoom + 'px'; 
                el.style.top = (e.clientY - oy) / currentZoom + 'px'; 
            };
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', () => window.removeEventListener('mousemove', move), {once:true});
        }

        function startResize(e, el) {
            const sw = el.offsetWidth, sh = el.offsetHeight, sx = e.clientX, sy = e.clientY;
            const resize = (e) => { 
                el.style.width = (sw + (e.clientX - sx) / currentZoom) + 'px'; 
                el.style.height = (sh + (e.clientY - sy) / currentZoom) + 'px'; 
            };
            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', () => window.removeEventListener('mousemove', resize), {once:true});
        }

        // --- UPDATED EXPORT LOGIC (Single File SPA) ---
        function exportCode() {
            saveCurrentPage(); // Save active page first
            
            const pageBg = document.getElementById('setting-page-bg').value;
            let allPagesHtml = '';

            // Generate HTML for all pages
            pages.forEach((page, index) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = page.content;
                
                // Clean up builder artifacts
                tempDiv.querySelectorAll('.element-controls, .resizer').forEach(e => e.remove());
                tempDiv.querySelectorAll('.builder-element').forEach(el => {
                    el.classList.remove('selected');
                    el.style.border = 'none';
                    if(el.querySelector('.element-content')) el.querySelector('.element-content').style.pointerEvents = 'auto';
                });

                // Wrap in a page container (Home is visible by default, others hidden)
                const displayStyle = index === 0 ? 'block' : 'none';
                const safeName = page.name.replace(/\s+/g, ''); // Remove spaces for ID
                allPagesHtml += `
                <div id="${safeName}" class="spa-page" style="display: ${displayStyle}; position: relative; width: 100%; height: 100%;">
                    ${tempDiv.innerHTML}
                </div>`;
            });

            // SPA Routing Script for the exported file
            const spaScript = `
            <script>
                function navigateTo(pageName) {
                    // Hide all pages
                    document.querySelectorAll('.spa-page').forEach(el => el.style.display = 'none');
                    // Show target page
                    const target = document.getElementById(pageName);
                    if(target) target.style.display = 'block';
                }

                // Intercept clicks on links starting with #
                document.addEventListener('click', function(e) {
                    if(e.target.tagName === 'A' && e.target.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        const page = e.target.getAttribute('href').substring(1);
                        navigateTo(page);
                    }
                });
            <\/script>`;

            const finalHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Exported Project</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        body { margin: 0; background: ${pageBg}; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        .page-container { 
            position: relative; width: ${canvas.offsetWidth}px; height: ${canvas.offsetHeight}px; 
            background: ${window.getComputedStyle(canvas).backgroundColor}; 
            overflow: hidden; flex-shrink: 0; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            ${canvas.style.borderRadius ? `border-radius: ${canvas.style.borderRadius}; margin-top: 20px;` : ''}
        }
        .builder-element { position: absolute; display: flex; }
        .element-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-decoration: none; }
    </style>
</head>
<body>
    <div class="page-container">
        ${allPagesHtml}
    </div>
    ${spaScript}
</body>
</html>`;

            const blob = new Blob([finalHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'website-export.html';
            a.click();
        }
    </script>
</body>
</html>
